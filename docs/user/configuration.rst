=============
Configuration
=============

This sections describes the configuration of Krake components and Rok. The
different parameters, their value and role will be described here

.. note::
    If an example value is specified for a parameter, it means this parameter
    has no default value in Krake.


Configuration file or command-line options
==========================================

There are two different ways to configure Krake components:

*  using the configuration files (also for Rok);
*  using command-line options (only for Krake components).


Configuration files
-------------------

There are 5 different configuration files:

*  ``api.yaml`` for the Krake API;
*  ``scheduler.yaml`` for the Scheduler as controller;
*  ``kubernetes.yaml`` for the Kubernetes Application controller;
*  ``garbage_collection.yaml`` for the Garbage Collector as controller;
*  ``rok.yaml`` for the Rok utility.

For each one of them except ``rok.yaml``, a template is present in the
``config`` directory. They end with the ``.template`` extension. For Rok, the
template configuration file is in the main directory of Krake.


Generate configuration
~~~~~~~~~~~~~~~~~~~~~~
From the templates, actual configuration files can be generated using the
``config/generate`` script. The templates have parameters that can be
overwritten by the script. It allows setting some parameters using
command-line options. The arguments and available options are:

``<src_files> <src_files> ...<src_files>`` (list of file paths)
    Positional arguments: the list of template files that will be used for
    generation.

``--dst`` (path to a directory)
    Optional argument: the directory in which the generated files will be
    created. Default: ``.`` (current directory).

``--tls-enabled``
    If used, set the TLS support to enabled between all Krake components. By
    default, TLS is disabled.

``--cert-dir <cert_dir>`` (path to a directory)
    Set the directory in which the certificates for the TLS communication
    should be stored. Default: ``"tmp/pki"``.

``--host <host>`` (Address)
    Host that will be used to create the endpoint of the API for the
    controllers. Default: ``"localhost"``.

``--port <port>`` (integer)
    Port that will be used to create the endpoint of the API for the
    controllers.. Default: ``8080``.

``--etcd-host <etcd_host>`` (Address)
    Host for the API to use to connect to the etcd database. Default:
    ``127.0.0.1``.

``--etcd-port <etcd_port>`` (integer)
    Port for the API to use to connect to the etcd database. Default: ``2379``.

``--worker-count <worker_count>`` (integer)
    Number of worker to start on the controller. Workers are the units that
    handle resources. Default: ``5``.

``--debounce <debounce>`` (float)
    For the controllers: the worker queue has a mechanism to delay a received
    state of a resource with a timer. A newer state received will then restart
    the timer. If a resource is updated a few times in one second, this
    mechanism prevents having to handle it each time by another component, and
    wait for the latest value. Default: ``1.0``.

``-h, --help``
    Display the help message and exit the script.



Examples
~~~~~~~~

To create default configuration files for Krake, the following command can be
used in the main directory:

.. code:: bash

    config/generate config/*template

This will create all Krake configuration files in the main directory of Krake.

To create default configuration files for Rok, the following command can be
used in the main directory:

.. code:: bash

    config/generate rok.yaml.template

This will create the Rok configuration file in the main directory of Krake.

The two previous commands can be combined together to generate both Rok and
Krake configuration files at the same time:

.. code:: bash

    config/generate config/*template rok.yaml.template

This will create Krake and Rok configuration files in the main directory of
Krake.

To create a new configuration for the API on the ``tmp`` directory with a
different etcd database endpoint, the following can be used:

.. code:: bash

    config/generate --dst /tmp config/api.yaml.template --etcd-host newhost.org --etcd-port 1234


Command-line options
--------------------

Apart from the configuration files, specific command-line options are
available for the Krake components. They are created automatically from the
configuration parameters. Nested options are generated by concatenating the
names of section with dashes characters (``"-"``). For example, the
``authentication.allow_anonymous`` YAML element becomes the
``--authentication-allow-anonymous`` option.

There is one option for each parameter of the configuration, except the
elements that are lists for the moment. Booleans are converted into optional
flags.


Krake configuration
===================

All configuration options for the Krake API are described here.

etcd
    This section defines the parameters to let the API communicate with the ETCD database.

    host (string)
        Address of the database. Example: ``127.0.0.1``
    port (integer), default: ``2379``
        Port to communicate with the database.
    retry_transactions (int):
        Number of times a database transaction will be attempted again if it failed the
        first time due to concurrent write on the same resource.

tls
    This section defines the parameters needed for TLS support. If TLS is enabled, all other components and clients need TLS support to communicate with the API.

    enabled (boolean)
        Activate or deactivate the TLS support. Example: ``false``
    client_cert (path)
        Set the path to the client certificate authority. Example: ``tmp/pki/system:api-server.pem``
    client_key (path)
        Set the path to the client certificate. Example: ``tmp/pki/system:api-server-key.pem``
    client_ca (path)
        Set the path to the client key. Example: ``tmp/pki/ca.pem``


Authentication:
---------------

authentication
    This section defines the method for authenticating users that connect to the API. Two methods are available: keystone_ and static_. A user not recognized can still send request if anonymous_ are allowed.

    allow_anonymous (boolean), default: ``false``
        .. _anonymous:

        Enable the "anonymous" user. Any request executed without a user being authenticated will be processed as user ``system:anonymous``.

    strategy
        This section describes the parameters for the methods of authentication.

        keystone
            .. _keystone:

            The Keystone service of OpenStack can be used as authentication method.

            enabled (boolean)
                Set Keystone as authentication method. Example: ``false``
            endpoint (URL)
                Endpoint of the Keystone service. Example: ``http://localhost:5000/v3``

        static
            .. _static:

            The user is set here, and the API will authenticate all requests as being sent by this user.

            enabled (boolean)
                Set the static method as authentication method. Example: ``true``
            name (string)
                This is the name of the user that will be set as sending all requests. Example: ``system``


Authorization
-------------

authorization (enumeration)
    This parameter defines the mode for allowing users to perform specific actions (e.g. "create" or "delete" a resource). Three modes are available: ``RBAC``, ``always-allow``, ``always-deny``.

default-roles (list)
    This section is a list of all the roles that have to be added to the database when starting the API.

    The syntax for each role is described in the following:

    metadata
        Here we define the metadata of the current role.

        name (string)
            .. _default-roles.metadata.name:

            The name of the role to add. Example: ``system:admin``

    rules (list)
        This section is a list of all rules that apply to the current role.

        api (string)
            The name of the API the current role is authorized to access. For all APIs to be accessible, the syntax: ``"all"`` must be used.
        namespaces (list of strings)
            The list of all namespaces the current role is authorized to access. For all namespaces to be accessible, the syntax: ``["all"]`` must be used.
        resources (list of strings)
            The list of all resources the current role is authorized to access. For all resources to be accessible, the syntax: ``["all"]`` must be used.
        verbs (list of strings)
            The list of verbs that corresponds to the operations this role is allowed to execute. Example: ``["create", "list", "get", "update", "delete"]``


default-role-bindings (list)
    This section is a list of all bindings between the defined users and roles. The syntax for each binding is described in the following:

    metadata
        Here we define the metadata of the current role binding.

        name (string)
            Name of the current binding. Example: ``system:admin``

    users (list of strings)
        List of users concerned by this binding. They will be given the roles listed in default-role-bindings.roles_. Example: ``["system:admin"]``
    roles (list of strings)
        .. _default-role-bindings.roles:

        List of roles concerned by this binding. The names listed have to correspond to the name of the roles, as defined in default-roles.metadata.name_. Example: ``["system:admin"]``.


Controllers configuration
=========================

The general configuration is the same for each controller. Additional parameters can be added for specific controllers, depending on the implementation. Here are the common parameters:

api_endpoint (URL)
    .. _controllers.controller_name.api_endpoint:

    Address of the API to be reached by the current controller. Example: ``http://localhost:8080``

debounce (float)
    For the worker queue of the controller: set the debounce time
    to delay the handling of a resource, and get any updated state
    in-between. Example ``1.5``

tls
    This section defines the parameters needed for TLS support. If TLS support is enabled on the API, it needs to be enabled on the controllers to let them communicate with the API.

    enabled (boolean)
        Activate or deactivate the TLS support. If the API uses only TLS, then this should be set to ``true``. This has priority over the scheme given by controllers.controller_name.api_endpoint_. Example: ``false``
    client_ca (path)
        Set the path to the client certificate authority. Example: ``./tmp/pki/ca.pem``
    client_cert (path)
        Set the path to the client certificate. Example: ``./tmp/pki/jc.pem``
    client_key (path)
        Set the path to the client key. Example: ``./tmp/pki/jc-key.pem``

Kubernetes application controller
---------------------------------
Additional parameters, specific for the Kubernetes application controller:

hooks (string)
    All the parameters for the application hooks are described here.

    complete (string)
        This section defines the parameters needed for the Application ``complete`` hook. If is not defined the Application ``complete`` hook is disabled.

        ca_dest (path)
            Set the path to the certificate authority in deployed Application. Example: ``/etc/krake_ca/ca.pem``
        env_token (string)
            Name of the environment variable, which stores Krake authentication token. Example: ``KRAKE_TOKEN``
        env_complete (string)
            Name of the environment variable, which stores Krake ``complete`` hook URL. Example: ``KRAKE_COMPLETE_URL``


Scheduler
---------
Additional parameters, specific for the Scheduler:

reschedule_after (float):
    Number of seconds between the last update or rescheduling of a resource and the
    next rescheduling. Example: ``60``
stickiness (float):
    Additional weight for the computation of the rank of the scheduler. It is added to
    the computation of the rank of the cluster on which a scheduled resource is
    actually running. It prevents migration from happening too frequently, and thus,
    represents the cost of migration. As the computation is done with normalized
    weights, the stickiness is advised to be between 0 and 1. Example: ``0.1``.


Common configuration:
=====================

The following elements are common for all components of Krake except Rok.

Logging
-------

log:
    This section is dedicated to the logging of the application. The syntax follows the one described for the Python logging_ module (``logging.config``). The content of this section will be given to this module for configuration.


--------------------------------


Rok configuration
=================

api_url (URL)
    .. _api_url:

    Address of the Krake API to connect to. If the scheme given is incompatible with the tls.enabled_ parameter, it will be overwritten to match. Example: ``http://localhost:8080``
user (string)
    The name of the user that will access the resources. Example: ``john-doe``

tls
    This section defines the parameters needed for TLS support, which can be used to communicate with the API.

    enabled (boolean)
        .. _tls.enabled:

        Activate or deactivate the TLS support. If the API uses only TLS, then this should be set to ``true``. This has priority over the scheme given by api_url_. Example: ``false``
    client_ca (path)
        Set the path to the client certificate authority. Example: ``./tmp/pki/ca.pem``
    client_cert (path)
        Set the path to the client certificate. Example: ``./tmp/pki/jc.pem``
    client_key (path)
        Set the path to the client key. Example: ``./tmp/pki/jc-key.pem``


.. _logging: https://docs.python.org/2/library/logging.config.html
