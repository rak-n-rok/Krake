stages:
  - provision
  - test
  - smoke test
  - integration test
  - cleanup


variables:
  ETCD_VER: v3.3.13

  # Change pip's cache directory to be inside the project directory since we
  # can only cache local items.
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"


# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/reference/pip_install/#caching
cache:
  paths:
    - .cache/pip


provision-staging-infra:
  stage: provision
  image: python:3.6
  artifacts:
    paths:
      - .ssh/id_rsa
      - ansible/.etc # Absolute path: /builds/ragnarok/krake/ansible/.etc
    expire_in: 1 week
  only:
    - staging
    - master
  script:
    - python -V
    - pip install python-openstackclient openstacksdk ansible==2.7.10 pytest
    # apt-get update -y && apt-get install openssh-client openssh-server rsync -y
    - apt-get update -y && apt-get install openssh-client rsync -y
    # /usr/bin/ssh-keygen -A
    # ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa
    # cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys && chmod 0600 ~/.ssh/authorized_keys
    # /etc/init.d/ssh start

    - mkdir .ssh/
    - openstack keypair delete --os-auth-url $OS_AUTH_URL --os-username $OS_USERNAME --os-project-name $OS_PROJECT_NAME --os-domain-name $OS_DOMAIN_NAME --os-project-domain-id $OS_PROJECT_DOMAIN_ID --os-password $OS_PASSWORD my_runner_key || true
    - openstack keypair create --os-auth-url $OS_AUTH_URL --os-username $OS_USERNAME --os-project-name $OS_PROJECT_NAME --os-domain-name $OS_DOMAIN_NAME --os-project-domain-id $OS_PROJECT_DOMAIN_ID --os-password $OS_PASSWORD my_runner_key > .ssh/id_rsa
    - chmod 600 .ssh/id_rsa
    - cat .ssh/id_rsa

    - export LC_ALL=C.UTF-8
    - echo "=== provisioning staging infrastructure ==="
    # Ansible refuses to read from a world-writeable folder, see https://github.com/webdevops/Dockerfile/issues/266#issuecomment-417291633
    - cd ansible
    - chmod -v -R 700 $(pwd)
    - ansible-playbook -i hosts-CI site.yml
    - pwd
    - ls -al ../.ssh/id_rsa
    - ls -al .etc




unittests-krake:
  stage: test
  image: python:3.6
  script:
    # Download etcd
    - mkdir /tmp/etcd-download
    - curl -s -L https://github.com/etcd-io/etcd/releases/download/$ETCD_VER/etcd-$ETCD_VER-linux-amd64.tar.gz -o /tmp/etcd.tar.gz
    - tar xzvf /tmp/etcd.tar.gz -C /tmp/etcd-download --strip-components=1
    - mv /tmp/etcd-download/etcd /usr/local/bin
    - rm -rf /tmp/etcd-download /tmp/etcd.tar.gz
    - etcd --version

    - pip install krake/[dev]
    - pip install keystone
    - pytest --runslow krake/tests
  tags:
    - docker


flake8-krake:
  stage: test
  image: python:3.6
  script:
    - pip install flake8
    - flake8 krake/krake
  tags:
    - docker

flake8-rok:
  stage: test
  image: python:3.6
  script:
    - pip install flake8
    - flake8 rok/rok
  tags:
    - docker


smoke_test:
  stage: smoke test
  image: python:3.6
  only:
    - staging
    - master
  script:
    - ls -al .ssh/id_rsa
    - ls -al ansible/.etc

    - pip install ansible==2.7.10
    - apt-get update -y && apt-get install openssh-client rsync -y

    - export LC_ALL=C.UTF-8
    - echo "=== provisioning staging infrastructure ==="
    # Ansible refuses to read from a world-writeable folder, see https://github.com/webdevops/Dockerfile/issues/266#issuecomment-417291633
    - cd ansible
    - chmod -v -R 700 $(pwd)
    - ansible-playbook -i hosts-CI smoke_tests.yml


integration_test:
  stage: integration test
  image: python:3.6
  only:
    - staging
    - master
  script:
    - ls -al .ssh/id_rsa
    - ls -al ansible/.etc

    - pip install ansible==2.7.10
    - apt-get update -y && apt-get install openssh-client rsync -y

    - export LC_ALL=C.UTF-8
    - echo "=== provisioning staging infrastructure ==="
    # Ansible refuses to read from a world-writeable folder, see https://github.com/webdevops/Dockerfile/issues/266#issuecomment-417291633
    - cd ansible
    - chmod -v -R 700 $(pwd)
    - ansible-playbook -i hosts-CI integration_tests.yml


cleanup-staging-infra:
  stage: cleanup
  image: python:3.6
  only:
    - staging
    - master
  script:
    - pip install python-openstackclient openstack-heat
    - openstack stack delete -y --os-auth-url $OS_AUTH_URL --os-username $OS_USERNAME --os-project-name $OS_PROJECT_NAME --os-domain-name $OS_DOMAIN_NAME --os-project-domain-id $OS_PROJECT_DOMAIN_ID --os-password $OS_PASSWORD krake-nightrun-network krake-nightrun-gateway krake-nightrun-app minikube-cluster-nightrun-1 || true
    - openstack keypair delete --os-auth-url $OS_AUTH_URL --os-username $OS_USERNAME --os-project-name $OS_PROJECT_NAME --os-domain-name $OS_DOMAIN_NAME --os-project-domain-id $OS_PROJECT_DOMAIN_ID --os-password $OS_PASSWORD my_runner_key || true
  when: always
